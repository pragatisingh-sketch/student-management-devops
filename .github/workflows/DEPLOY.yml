name: Spring Boot CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT }}
      SERVICE: github-deploy
      REGION: asia-south1

    steps:
    # 1️⃣ Checkout code
    - name: Checkout
      uses: actions/checkout@v4

    # 2️⃣ Setup Java 17
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3️⃣ Make Maven wrapper executable
    - name: Permission
      run: chmod +x mvnw

    # 4️⃣ Cache Maven dependencies
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    # 5️⃣ Build JAR
    - name: Build JAR
      run: ./mvnw clean package -DskipTests

    # 6️⃣ Authenticate to GCP
    - name: Auth GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_KEY }}

    # 7️⃣ Setup gcloud CLI
    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2

    # 8️⃣ Build Docker image and push to Container Registry
    - name: Build Docker Image
      shell: bash
      run: |
        # We assign to a local variable and trim any potential whitespace/newlines
        CLEAN_PROJECT_ID=$(echo "${{ env.PROJECT_ID }}" | xargs)
        IMAGE_NAME=$(echo "${{ env.SERVICE }}" | tr '[:upper:]' '[:lower:]' | xargs)
        
        IMAGE_TAG="gcr.io/${CLEAN_PROJECT_ID}/${IMAGE_NAME}"
        
        echo "Building Docker image: $IMAGE_TAG"
        gcloud builds submit --tag "$IMAGE_TAG" .

    # 9️⃣ Deploy to Cloud Run
    - name: Deploy to Cloud Run
      shell: bash
      run: |
        CLEAN_PROJECT_ID=$(echo "${{ env.PROJECT_ID }}" | xargs)
        IMAGE_NAME=$(echo "${{ env.SERVICE }}" | tr '[:upper:]' '[:lower:]' | xargs)
        
        IMAGE_TAG="gcr.io/${CLEAN_PROJECT_ID}/${IMAGE_NAME}"
        
        echo "Deploying $IMAGE_NAME to region ${{ env.REGION }}..."
        
        gcloud run deploy "$IMAGE_NAME" \
          --image "$IMAGE_TAG" \
          --region "${{ env.REGION }}" \
          --platform managed \
          --allow-unauthenticated
